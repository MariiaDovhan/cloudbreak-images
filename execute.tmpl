#!/bin/sh
[[ "$TRACE" ]] && set -x

: ${RUN_GLANCE_IN_DOCKER:=false}

_glance() {

  if [[ "$RUN_GLANCE_IN_DOCKER" == "true" ]]; then
      docker run \
        -v $PWD:/work \
        -w /work \
        -e OS_IMAGE_NAME=$OS_IMAGE_NAME \
        -e OS_AUTH_URL=$OS_AUTH_URL \
        -e OS_PASSWORD=$OS_PASSWORD \
        -e OS_TENANT_NAME=$OS_TENANT_NAME \
        -e OS_USERNAME=$OS_USERNAME \
        sequenceiq/glance-cli:0.19.0 \
      "$@"
  else
    glance "$@"
  fi
}

main() {
    echo "===> list all images with glance: "
    _glance image-list

    echo "===> show detail about actual: "
    _glance image-show {{ .Config.PackerUserVars.os_image_name }}

    echo "===> glance cli will download {{ .Config.PackerUserVars.os_image_name }}.img"
    _glance image-download --file {{ .Config.PackerUserVars.os_image_name }}.img {{ .Artifact.Id }}

    ls -lrth *.img || true
}

[[ "$0" == "$BASH_SOURCE" ]] && main "$@"

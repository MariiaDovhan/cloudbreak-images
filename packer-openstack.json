{
  "variables": {
    "mock": "{{ env `MOCK` }}",
    "atlas_token": "{{ env `ATLAS_TOKEN`}}",
    "atlas_artifact": "cloudbreak",

    "os_user": "cloudbreak",

    "os_auth_url": "{{ env `OS_AUTH_URL` }}",
    "os_image_name": "cloudbreak-{{ isotime \"2006-01-02-15-04\" }}{{env `IMAGE_NAME_SUFFIX`}}",
    "os_username": "{{ env `OS_USERNAME` }}",
    "os_password": "{{ env `OS_PASSWORD` }}",
    "os_tenant_name": "{{ env `OS_TENANT_NAME` }}",

    "ambari_version": "{{ env `AMBARI_VERSION` }}",
    "ambari_baseurl": "{{ env `AMBARI_BASEURL` }}",
    "ambari_gpgkey": "{{ env `AMBARI_GPGKEY` }}",
    "hdp_version": "{{ env `HDP_VERSION` }}",
    "hdp_stack_version": "{{ env `HDP_STACK_VERSION` }}",
    "hdp_repoid": "{{ env `HDP_REPOID` }}",
    "hdp_baseurl": "{{ env `HDP_BASEURL` }}",
    "hdputil_version": "{{ env `HDPUTIL_VERSION` }}",
    "hdputil_repoid": "{{ env `HDPUTIL_REPOID` }}",
    "hdputil_baseurl": "{{ env `HDPUTIL_BASEURL` }}",
    "git_rev": "{{ env `GIT_REV` }}",
    "git_branch": "{{ env `GIT_BRANCH` }}",
    "git_tag": "{{ env `GIT_TAG` }}"
  },
  "builders": [
    {
      "type": "openstack",
      "username": "{{user `os_username`}}",
      "password": "{{user `os_password`}}",
      "tenant_name": "{{user `os_tenant_name`}}",
      "ssh_username": "centos",
      "ssh_pty": "true",
      "image_name": "{{user `os_image_name`}}",
      "source_image": "d619e553-6a78-4b86-8b03-39b8a06df35e",
      "flavor": "m1.medium",
      "endpoint_type": "internalURL",
      "networks": [
            "a5ad7a1d-d3a6-4180-8d61-07a23f6fb449"
      ]
    }
  ],
  "provisioners": [
      {
        "type": "file",
        "source": "shared",
        "destination": "/tmp"
      },
      {
          "type": "shell",
          "inline": [
            "sudo chown -R root:root /tmp/shared",
            "sudo rsync -a --ignore-existing /tmp/shared/pre/ /"]
      },
      {
        "type": "shell",
        "scripts": [
            "./user-data-script.sh"
        ],
        "environment_vars": [
            "OS_USER={{ user `os_user` }}",
            "TRACE=1",
            "AMBARI_VERSION={{user `ambari_version`}}",
            "AMBARI_BASEURL={{user `ambari_baseurl`}}",
            "AMBARI_GPGKEY={{user `ambari_gpgkey`}}",
            "HDP_VERSION={{user `hdp_version`}}",
            "HDP_STACK_VERSION={{user `hdp_stack_version`}}",
            "HDP_REPOID={{user `hdp_repoid`}}",
            "HDP_BASEURL={{user `hdp_baseurl`}}",
            "HDPUTIL_VERSION={{user `hdputil_version`}}",
            "HDPUTIL_REPOID={{user `hdputil_repoid`}}",
            "HDPUTIL_BASEURL={{user `hdputil_baseurl`}}"
        ],
        "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E bash '{{ .Path }}'"
      },
      {
        "type": "shell",
        "inline": [
          "sudo chown -R root:root /tmp/shared",
          "sudo rsync -a --ignore-existing /tmp/shared/post/ /"
        ]
      }
  ],

  "post-processors": [
    [
      {
        "type": "atlas",
        "token": "{{user `atlas_token`}}",
        "artifact": "sequenceiq/{{ user `atlas_artifact` }}",
        "artifact_type": "openstack.image",
        "metadata": {
          "created_at": "{{timestamp}}",
          "created" :"{{ isotime \"2006-01-02 15:04:05 -0700\" }}",
          "git_rev": "{{user `git_rev`}}",
          "git_branch": "{{user `git_branch`}}",
          "git_tag": "{{user `git_tag`}}",
          "os_user": "{{user `os_user` }}",
          "orchestrator": "salt",
          "image_name": "{{ user `os_image_name` }}",
          "ambari_version": "{{ user `ambari_version` }}",
          "ambari_baseurl": "{{ user `ambari_baseurl` }}",
          "ambari_gpgkey": "{{ user `ambari_gpgkey` }}",
          "hdp_version": "{{user `hdp_version`}}",
          "hdp_baseurl": "{{ user `hdp_baseurl` }}",
          "hdp_repoid": "{{ user `hdp_repoid` }}",
          "hdputil_version": "{{user `hdputil_version`}}",
          "hdputil_baseurl": "{{ user `hdputil_baseurl` }}",
          "hdputil_repoid": "{{ user `hdputil_repoid` }}",
          "source_image": "CentOS-7-x86_64-GenericCloud-1601"
        }
      }
    ]
  ]
}

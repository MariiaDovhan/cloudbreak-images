{
  "variables": {
    "mock": "{{ env `MOCK` }}",

    "aws_access_key": "{{ env `AWS_ACCESS_KEY` }}",
    "aws_secret_key": "{{ env `AWS_SECRET_ACCESS_KEY` }}",
    "gcp_account_file": "{{env `GCP_ACCOUNT_FILE`}}",
    "os_auth_url": "{{ env `OS_AUTH_URL` }}",
    "os_username": "{{ env `OS_USERNAME` }}",
    "os_password": "{{ env `OS_PASSWORD` }}",
    "os_tenant_name": "{{ env `OS_TENANT_NAME` }}",
	"sn" : "{{env `AZURE_SUBSCRIPTION_NAME`}}",
	"psPath" : "{{env `AZURE_PUBLISH_SETTINGS`}}",


    "docker_images": "gliderlabs/alpine:3.1 alpine:latest sequenceiq/mybatis-migrations:1.0.0 sequenceiq/cb-shell:1.2.5",
    "cbd_install_dir": "/bin",
    "cbd_version": "{{ env `CBD_VERSION`}}",
    "os_user": "cloudbreak",
    "atlas_artifact": "cbd",
    "image_name": "cloudbreak-deployer-{{ env `CBD_VERSION_UNDERSCORE`}}-{{ isotime \"2006-01-02\" }}{{env `IMAGE_NAME_SUFFIX`}}",


    "instance_type": "m3.medium"
  },
  "builders":[
    {
      "type": "openstack",
      "username": "{{user `os_username`}}",
      "password": "{{user `os_password`}}",
      "tenant_name": "{{user `os_tenant_name`}}",
      "ssh_username": "cloudbreak",
      "ssh_pty": "true",
      "image_name": "{{user `image_name`}}",
      "source_image": "7c6d76ba-99de-434f-ba51-c9b6c7bc39ab",
      "flavor": "m1.medium",
      "use_floating_ip": true,
      "floating_ip_pool": "8a1ca549-30cb-4fd5-9d32-84a42433558b",
      "networks": [
        "6414de5e-6085-4469-b8e9-aa293a65c828"
      ]
    }
  ],
  "provisioners": [
  {
      "type": "shell",
      "inline": [
          "sudo rm -rf /tmp/shared"
      ]
  },
  {
    "type": "file",
    "source": "shared",
    "destination": "/tmp"
  },
  {
      "type": "shell",
      "inline": [
          "sudo yum install -y rsync",
          "sudo rsync -a /tmp/shared/ /"
      ]
  },
  {
    "type": "shell",
    "scripts": [
        "./pull-docker-images.sh",
        "./cbd-init.sh"
    ],
    "environment_vars": [
        "CBD_VERSION={{ user `cbd_version` }}",
        "CBD_INSTALL_DIR={{ user `cbd_install_dir` }}",
        "OS_USER={{ user `os_user` }}",
        "YUM_VERSION_DOCKER={{ user `yum_version_docker` }}",
        "YUM_VERSION_KERNEL={{ user `yum_version_kernel` }}",
        "YUM_VERSION_SYSTEMD={{ user `yum_version_systemd` }}",
        "PACKER_IMAGE_NAME={{user `image_name`}}",
        "IMAGES={{ user `docker_images` }}",
        "TRACE=1"
    ],
    "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E bash '{{ .Path }}'"
  }
  ]
  ,"post-processors": [
    [
      {
        "type": "generator",
        "template": "{{ build_name }}.tmpl",
        "output": "{{ build_name }}.yml"
      },
      {
        "type": "atlas",
        "artifact": "sequenceiq/{{ user `atlas_artifact` }}",
        "artifact_type": "{{ build_name }}.yml",
        "metadata": {
            "created_at": "{{timestamp}}",
            "created" :"{{ isotime \"2006-01-02 15:04:05 -0700\" }}",
            "cbd_version": "{{ user `cbd_version` }}",
            "os_user": "{{user `os_user` }}",
            "image_name": "{{ user `image_name` }}",
            "yum_version_docker": "{{ user `yum_version_docker` }}"
        }
      }
    ],
    [
        {
            "type":"generator",
            "Template": "execute.tmpl",
            "Output": "./execute.sh"
        }
        ,{
            "type": "artifice",
            "files": ["{{ user `image_name` }}.img"]
        },
        {
          "type": "atlas",
          "artifact": "sequenceiq/{{ user `atlas_artifact` }}",
          "artifact_type": "{{ build_name }}.image",
          "metadata": {
            "created_at": "{{timestamp}}",
            "created" :"{{ isotime \"2006-01-02 15:04:05 -0700\" }}",
            "cbd_version": "{{ user `cbd_version` }}",
            "os_user": "{{user `os_user` }}",
            "image_name": "{{ user `image_name` }}",
            "yum_version_docker": "{{ user `yum_version_docker` }}"
          }
        }
    ]
  ]

}

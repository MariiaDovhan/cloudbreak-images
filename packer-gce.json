{
  "variables": {
    "mock": "{{ env `MOCK` }}",
    "namesuffix": "{{env `IMAGE_NAME_SUFFIX`}}",
    "account_file": "{{env `GCE_ACCOUNT_FILE`}}",
    "atlas_token": "{{ env `ATLAS_TOKEN`}}",
    "atlas_artifact": "cloudbreak",
    "image_name": "cb-centos71-amb212-{{ isotime \"2006-01-02\" }}{{env `IMAGE_NAME_SUFFIX`}}"
  },
  "builders":[{
    "disk_size": "40",
    "name": "us-central1-b",
    "type": "googlecompute",
    "account_file": "{{user `account_file`}}",
    "source_image": "centos-7-v20150603",
    "zone": "us-central1-b",
    "project_id": "siq-haas",
    "ssh_username": "centos",
    "ssh_pty": "true",
    "machine_type": "n1-standard-2",
    "image_name": "{{user `image_name`}}",
    "tags": [
	"packer"
    ]
  }],
  "provisioners": [{
    "type": "file",
    "source": "shared/",
    "destination": "/tmp"
  },
  {
    "type": "shell",
    "script": "./user-data-script.sh",
    "environment_vars": [
        "OS_USER={{ user `os_user` }}",
        "YUM_VERSION_DOCKER={{ user `yum_version_docker` }}",
        "YUM_VERSION_KERNEL={{ user `yum_version_kernel` }}",
        "YUM_VERSION_SYSTEMD={{ user `yum_version_systemd` }}",
        "IMAGES={{ user `cb_docker_container_ambari_warmup` }} {{ user `cb_docker_container_ambari` }} {{ user `cb_docker_container_docker_consul_watch_plugn` }} {{ user `cb_docker_container_registrator` }} {{ user `cb_docker_container_baywatch_server` }} {{ user `cb_docker_container_baywatch_client` }} {{ user `cb_docker_container_logrotate` }} {{ user `cb_docker_container_kerberos` }} {{ user `cb_docker_container_ambari_db` }} {{ user `cb_docker_container_munchausen` }} {{ user `cb_docker_container_consul` }} {{ user `cb_docker_container_gateway` }} {{ user `cb_docker_container_alpine` }} {{ user `cb_docker_container_swarm` }} {{ user `cb_docker_container_cert_tool` }} {{ user `cb_docker_container_list_others` }}",
        "TRACE=1"
    ],
 
    "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E bash '{{ .Path }}'"
  },
  {
    "type": "shell",
    "script": "./optimization-script-for-hdp.sh",
    "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E bash '{{ .Path }}'"
  },
  {
    "type": "shell",
    "script": "./create-gc-image.sh",
    "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} PACKER_IMAGE_NAME={{user `image_name`}} sudo -E bash '{{ .Path }}'"
  }]
  ,"post-processors": [
      [
          {
      "type":"generator",
      "template":"gce.tmpl",
      "output":"gce.yml"
          }
          ,{
            "type": "atlas",
            "token": "{{user `atlas_token`}}",
            "artifact": "sequenceiq/{{ user `atlas_artifact` }}",
            "artifact_type": "googlecompute.image",
            "metadata": {
              "created_at": "{{timestamp}}"
            }
          }
      ]
    ]
}
